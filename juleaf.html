<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juleaf Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-right: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header h1 img { height: 28px; width: auto; }
        
        .divider { width: 1px; height: 24px; background: rgba(255,255,255,0.3); margin: 0 4px; }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 7px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover { background: #2980b9; transform: translateY(-1px); }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }
        .btn.compile { background: #27ae60; }
        .btn.compile:hover { background: #219a52; }
        .btn.secondary { background: #7f8c8d; }
        .btn.secondary:hover { background: #6c7a7b; }
        
        .spacer { flex: 1; }
        
        .status {
            font-size: 11px;
            color: #ecf0f1;
            padding: 4px 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        .container { display: flex; height: calc(100vh - 48px); }
        .container.panel-open { height: calc(100vh - 48px - 280px); }
        
        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .resizer {
            width: 6px;
            background: #bdc3c7;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        
        .resizer:hover { background: #3498db; }
        
        .editor-header {
            background: #ecf0f1;
            padding: 8px 12px;
            font-size: 12px;
            color: #555;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-header input {
            border: none;
            background: transparent;
            font-size: 12px;
            color: #333;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 3px;
            width: 150px;
        }
        
        .editor-header input:hover { background: rgba(0,0,0,0.05); }
        .editor-header input:focus { background: white; outline: 1px solid #3498db; }
        
        .editor {
            flex: 1;
            border: none;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            tab-size: 2;
        }
        
        .preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        
        .preview-header {
            background: #ecf0f1;
            padding: 8px 12px;
            font-size: 12px;
            color: #555;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pdf-viewer { flex: 1; border: none; background: #525659; }
        
        .console-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 280px;
            background: #1e1e1e;
            border-top: 3px solid #3498db;
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        
        .console-panel.visible { display: flex; }
        
        .console-header {
            background: #2c2c2c;
            padding: 8px 12px;
            color: #ccc;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-close {
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 18px;
            padding: 0 8px;
        }
        
        .console-close:hover { color: #fff; }
        
        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.5;
            color: #d4d4d4;
            white-space: pre-wrap;
        }
        
        .console-content .error { color: #e74c3c; }
        .console-content .success { color: #27ae60; }
        
        .settings-textarea {
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-size: 12px;
            padding: 12px;
            resize: none;
            outline: none;
        }
        
        body.dark-theme { background: #1e1e1e; }
        body.dark-theme .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        body.dark-theme .editor { background: #252526; color: #d4d4d4; }
        body.dark-theme .editor-header,
        body.dark-theme .preview-header { background: #2d2d2d; color: #ccc; border-bottom-color: #444; }
        body.dark-theme .editor-header input { color: #ccc; }
        body.dark-theme .editor-header input:focus { background: #333; }
        body.dark-theme .preview-pane { background: #1e1e1e; }
        body.dark-theme .resizer { background: #444; }
        
        select.btn {
            appearance: none;
            padding-right: 22px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-overlay.visible { display: flex; }
        
        .modal {
            background: white;
            border-radius: 8px;
            padding: 24px;
            min-width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        body.dark-theme .modal { background: #2d2d2d; color: #eee; }
        
        .modal h2 { margin-bottom: 16px; font-size: 18px; }
        
        .modal-files {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        body.dark-theme .modal-files { border-color: #444; }
        
        .modal-file {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.dark-theme .modal-file { border-bottom-color: #444; }
        .modal-file:hover { background: #f5f5f5; }
        body.dark-theme .modal-file:hover { background: #383838; }
        .modal-file:last-child { border-bottom: none; }
        .modal-file-name { font-weight: 500; }
        .modal-file-date { font-size: 11px; color: #888; }
        .modal-file-delete { color: #c0392b; cursor: pointer; padding: 4px 8px; border-radius: 3px; }
        .modal-file-delete:hover { background: rgba(192,57,43,0.1); }
        .modal-buttons { display: flex; gap: 8px; justify-content: flex-end; }
        
        .unsaved-dot {
            width: 8px; height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            margin-left: 6px;
        }
        
        .hidden { display: none !important; }
        
        .workspace-panel {
            width: 220px;
            background: #f5f5f5;
            border-right: 1px solid #ddd;
            display: none;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .workspace-panel.visible { display: flex; }
        
        body.dark-theme .workspace-panel { background: #252526; border-right-color: #444; }
        
        .workspace-header {
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.dark-theme .workspace-header { color: #999; border-bottom-color: #444; }
        
        .workspace-header button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .workspace-header button:hover { background: rgba(0,0,0,0.1); }
        body.dark-theme .workspace-header button { color: #999; }
        body.dark-theme .workspace-header button:hover { background: rgba(255,255,255,0.1); }
        
        .workspace-files {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        
        .workspace-file {
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
        }
        
        body.dark-theme .workspace-file { color: #ccc; }
        
        .workspace-file:hover { background: rgba(0,0,0,0.05); }
        body.dark-theme .workspace-file:hover { background: rgba(255,255,255,0.05); }
        
        .workspace-file.active { background: #e3f2fd; }
        body.dark-theme .workspace-file.active { background: #1e3a5f; }
        
        .workspace-file-icon { font-size: 14px; }
        
        .workspace-file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .workspace-file-size {
            font-size: 10px;
            color: #999;
        }
        
        .workspace-empty {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 12px;
        }
        
        .workspace-section {
            padding: 8px 12px 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><img src="/logo" alt="Juleaf">Juleaf</h1>
        <div class="divider"></div>
        <button class="btn secondary" onclick="toggleWorkspace()" title="Workspace">üìÅ</button>
        <button class="btn secondary" onclick="newFile()" title="Ctrl+N">üìÑ New</button>
        <button class="btn secondary" onclick="openFiles()" title="Ctrl+O">üìÇ Open</button>
        <button class="btn secondary" onclick="saveFile()" title="Ctrl+S">üíæ Save</button>
        <button class="btn secondary" onclick="downloadSource()">‚¨á Export</button>
        <div class="divider"></div>
        <select class="btn" id="templateSelect" onchange="loadTemplate()">
            <option value="">üìÑ Templates</option>
            <option value="article">Article / Report</option>
            <option value="ieee">IEEE Conference</option>
            <option value="beamer">Beamer Slides</option>
            <option value="letter">Letter</option>
            <option value="mathpaper">Math Paper</option>
        </select>
        <div class="divider"></div>
        <button class="btn compile" onclick="compile()" title="Ctrl+Enter">‚ñ∂ Compile</button>
        <button class="btn" style="background:#9b59b6" onclick="aiAssist()" title="AI Help (Ctrl+I)">‚ú® AI</button>
        <span class="spacer"></span>
        <button class="btn secondary" onclick="toggleConsole()">Console</button>
        <button class="btn secondary" onclick="toggleSettings()">‚öô</button>
        <button class="btn secondary" onclick="setApiKey()" title="Set API Key">üîë</button>
        <button class="btn secondary" onclick="toggleTheme()" id="themeBtn">üåô</button>
        <span class="status" id="status">Ready</span>
    </div>
    
    <div class="container">
        <div class="workspace-panel" id="workspacePanel">
            <div class="workspace-header">
                <span>Workspace</span>
                <button onclick="refreshWorkspace()" title="Refresh">üîÑ</button>
            </div>
            <div class="workspace-files" id="workspaceFiles">
                <div class="workspace-empty">Loading...</div>
            </div>
        </div>
        <div class="editor-pane">
            <div class="editor-header">
                <div style="display:flex;align-items:center;">
                    <input type="text" id="fileName" value="tutorial.jmd" />
                    <div class="unsaved-dot hidden" id="unsavedDot" title="Unsaved changes"></div>
                </div>
                <span style="color:#888;font-size:11px;">Ctrl+S save ‚Ä¢ Ctrl+Enter compile</span>
            </div>
            <textarea class="editor" id="editor" spellcheck="false">---
title: "Juleaf Quick Start"
author: "Tutorial"
date: today
---

![Juleaf Logo](juleaf_logo.png){ width=120px }

# Welcome to Juleaf

**Juleaf** combines Julia + Weave + LaTeX for scientific documents with live code execution.

---

## Keyboard Shortcuts

| Action | Shortcut |
|--------|----------|
| Save | Ctrl+S |
| Compile | Ctrl+Enter |
| New File | Ctrl+N |
| Open Files | Ctrl+O |

---

## Writing Math

Inline: $E = mc^2$ or display mode:

$$\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}$$

---

## Julia Code Blocks

Use triple backticks with `julia`:

```julia
using Statistics
x = randn(100)
println("Mean: ", round(mean(x), digits=3))
println("Std:  ", round(std(x), digits=3))
```

---

## Plotting

```julia
using CairoMakie
fig = Figure(size=(500, 250))
ax = Axis(fig[1,1], xlabel="x", ylabel="sin(x)")
x = range(0, 4œÄ, 100)
lines!(ax, x, sin.(x), linewidth=2)
fig
```

---

## Templates

Click **Templates** dropdown for:

- **Article** ‚Äî reports, papers
- **IEEE** ‚Äî conference format
- **Beamer** ‚Äî presentations
- **Letter** ‚Äî formal letters
- **Math Paper** ‚Äî theorems, proofs

---

## Tips

1. Auto-compile triggers 1.5s after typing
2. Use **‚öô Packages** to add LaTeX packages
3. Check **Console** for errors
4. Files save to browser storage

---

*Select a template or start writing!*
</textarea>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="preview-pane" id="previewPane">
            <div class="preview-header">
                <span>Preview (PDF)</span>
                <button class="btn secondary" onclick="downloadPDF()" style="padding:4px 10px;font-size:11px;">‚¨á PDF</button>
            </div>
            <iframe class="pdf-viewer" id="preview"></iframe>
        </div>
    </div>
    
    <div class="console-panel" id="console">
        <div class="console-header">
            <span>üìã Console</span>
            <button class="console-close" onclick="toggleConsole()">√ó</button>
        </div>
        <div class="console-content" id="console-output">Waiting...</div>
    </div>
    
    <div class="console-panel" id="settings">
        <div class="console-header">
            <span>‚öô LaTeX Packages</span>
            <button class="console-close" onclick="toggleSettings()">√ó</button>
        </div>
        <div class="console-content">
            <textarea id="custom-packages" class="settings-textarea" placeholder="Add packages here..."></textarea>
        </div>
    </div>
    
    <div class="modal-overlay" id="openModal">
        <div class="modal">
            <h2>üìÇ Your Documents</h2>
            <div class="modal-files" id="filesList"></div>
            <div class="modal-buttons">
                <button class="btn secondary" onclick="uploadFile()">üì§ Upload</button>
                <button class="btn secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="fileInput" accept=".jmd,.tex,.md" style="display:none" onchange="handleUpload(event)">
    
    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const status = document.getElementById('status');
        const fileNameInput = document.getElementById('fileName');
        const unsavedDot = document.getElementById('unsavedDot');
        
        let compiling = false, autoCompileTimeout = null, isResizing = false;
        let hasUnsavedChanges = false, currentFileId = null, lastSavedContent = '';
        
        const STORAGE_KEY = 'juleaf_files';
        const getFiles = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        const saveFiles = files => localStorage.setItem(STORAGE_KEY, JSON.stringify(files));
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        function markUnsaved() {
            if (editor.value !== lastSavedContent) {
                hasUnsavedChanges = true;
                unsavedDot.classList.remove('hidden');
            }
        }
        
        function markSaved() {
            hasUnsavedChanges = false;
            lastSavedContent = editor.value;
            unsavedDot.classList.add('hidden');
        }
        
        function newFile() {
            if (hasUnsavedChanges && !confirm('Discard unsaved changes?')) return;
            currentFileId = null;
            fileNameInput.value = 'untitled.jmd';
            editor.value = '---\ntitle: "Untitled"\nauthor: "Your Name"\ndate: today\n---\n\n# Introduction\n\nStart writing here...\n\n```julia\n# Your Julia code\nprintln("Hello!")\n```\n';
            markSaved();
            compile();
        }
        
        function saveFile() {
            const files = getFiles();
            if (!currentFileId) currentFileId = generateId();
            files[currentFileId] = {
                name: fileNameInput.value || 'untitled.jmd',
                content: editor.value,
                packages: document.getElementById('custom-packages').value,
                updatedAt: new Date().toISOString()
            };
            saveFiles(files);
            markSaved();
            status.textContent = '‚úì Saved';
            setTimeout(() => status.textContent = 'Ready', 2000);
        }
        
        function openFiles() {
            const files = getFiles();
            const entries = Object.entries(files).sort((a, b) => new Date(b[1].updatedAt) - new Date(a[1].updatedAt));
            const list = document.getElementById('filesList');
            
            if (entries.length === 0) {
                list.innerHTML = '<div style="padding:20px;color:#888;text-align:center;">No saved documents</div>';
            } else {
                list.innerHTML = entries.map(([id, f]) => `
                    <div class="modal-file" onclick="loadFile('${id}')">
                        <div>
                            <div class="modal-file-name">${f.name}</div>
                            <div class="modal-file-date">${new Date(f.updatedAt).toLocaleString()}</div>
                        </div>
                        <span class="modal-file-delete" onclick="event.stopPropagation();deleteFile('${id}')">üóë</span>
                    </div>
                `).join('');
            }
            document.getElementById('openModal').classList.add('visible');
        }
        
        function loadFile(id) {
            if (hasUnsavedChanges && !confirm('Discard unsaved changes?')) return;
            const file = getFiles()[id];
            if (file) {
                currentFileId = id;
                fileNameInput.value = file.name;
                editor.value = file.content;
                document.getElementById('custom-packages').value = file.packages || '';
                markSaved();
                closeModal();
                compile();
            }
        }
        
        function deleteFile(id) {
            if (!confirm('Delete permanently?')) return;
            const files = getFiles();
            delete files[id];
            saveFiles(files);
            if (currentFileId === id) currentFileId = null;
            openFiles();
        }
        
        function closeModal() { document.getElementById('openModal').classList.remove('visible'); }
        function uploadFile() { document.getElementById('fileInput').click(); }
        
        function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (hasUnsavedChanges && !confirm('Discard unsaved changes?')) return;
            const reader = new FileReader();
            reader.onload = ev => {
                currentFileId = null;
                fileNameInput.value = file.name;
                editor.value = ev.target.result;
                markSaved();
                closeModal();
                compile();
            };
            reader.readAsText(file);
            e.target.value = '';
        }
        
        function downloadSource() {
            const blob = new Blob([editor.value], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileNameInput.value || 'document.jmd';
            a.click();
        }
        
        function downloadPDF() {
            const a = document.createElement('a');
            a.href = '/output.pdf';
            a.download = (fileNameInput.value || 'document').replace(/\.[^.]+$/, '') + '.pdf';
            a.click();
        }
        
        const templates = {
            article: { 
                code: `---
title: "Article Title"
author: "Author Name"
date: today
---

# Introduction

Your text here.

\`\`\`julia
using Statistics
data = randn(1000)
println("Mean: ", round(mean(data), digits=4))
\`\`\`

# Results

\`\`\`julia
using CairoMakie
fig = Figure(size=(500, 300))
ax = Axis(fig[1,1])
hist!(ax, data, bins=30)
fig
\`\`\``, 
                packages: '' 
            },
            ieee: { 
                code: `---
documentclass: IEEEtran
classoption: conference
---

\\title{Your Paper Title}

\\author{
\\IEEEauthorblockN{First Author}
\\IEEEauthorblockA{\\textit{Department Name} \\\\
\\textit{University Name}\\\\
City, Country \\\\
email@example.com}
\\and
\\IEEEauthorblockN{Second Author}
\\IEEEauthorblockA{\\textit{Department Name} \\\\
\\textit{University Name}\\\\
City, Country \\\\
email@example.com}
}

\\maketitle

\\begin{abstract}
Your abstract text here (150-250 words).
\\end{abstract}

\\begin{IEEEkeywords}
keyword1, keyword2, keyword3
\\end{IEEEkeywords}

\\section{Introduction}
Introduction text here.

\\section{Methodology}

The optimization problem:
$$
\\min_{\\mathbf{x}} f(\\mathbf{x}) = \\|\\mathbf{Ax} - \\mathbf{b}\\|_2^2
$$

\`\`\`julia
using LinearAlgebra
A = randn(50, 5)
b = randn(50)
x = A \\ b
println("Solution norm: ", round(norm(x), digits=4))
\`\`\`

\\section{Results}

\`\`\`julia
using CairoMakie
fig = Figure(size=(400, 250))
ax = Axis(fig[1,1], xlabel="Index", ylabel="Residual")
scatter!(ax, 1:length(A*x-b), A*x-b, markersize=4)
fig
\`\`\`

\\section{Conclusion}
Conclusions and future work.

\\begin{thebibliography}{00}
\\bibitem{b1} A. Author, "Paper Title," Journal, vol. 1, pp. 1-10, 2024.
\\end{thebibliography}`, 
                packages: '\\usepackage{cite}\n\\usepackage{amsmath,amssymb}\n\\usepackage{graphicx}' 
            },
            beamer: { 
                code: `---
title: "Presentation"
author: "Your Name"
date: today
documentclass: beamer
theme: Madrid
colortheme: whale
---

# Introduction

## Welcome

Features:

- Julia code
- LaTeX math
- PDF output

# Results

## Code Example

\`\`\`julia
using Statistics
x = randn(100)
println("Mean: ", round(mean(x), digits=3))
\`\`\`

## Thank You

Questions?`, 
                packages: '' 
            },
            letter: { 
                code: `---
documentclass: letter
---

\\documentclass{letter}
\\usepackage[margin=1in]{geometry}

\\address{Your Name \\\\ Your Address \\\\ City, Country}
\\date{\\today}

\\begin{document}

\\begin{letter}{Recipient Name \\\\ Recipient Address \\\\ City, Country}

\\opening{Dear Sir or Madam,}

Your message here.

\\closing{Sincerely,}

\\end{letter}

\\end{document}`, 
                packages: '' 
            },
            mathpaper: { 
                code: `---
title: "Mathematical Analysis"
author: "Author Name"
date: today
header-includes:
  - \\usepackage{amsthm}
  - \\newtheorem{theorem}{Theorem}
  - \\newtheorem{lemma}{Lemma}
---

# Introduction

Mathematical typesetting with Julia.

\\begin{theorem}
Let $f$ be continuous on $[a,b]$. Then $f$ is integrable on $[a,b]$.
\\end{theorem}

## Numerical Verification

\`\`\`julia
using QuadGK
f(x) = exp(-x^2)
result, _ = quadgk(f, -Inf, Inf)
println("‚à´ exp(-x¬≤) dx = ", round(result, digits=6))
println("‚àöœÄ = ", round(sqrt(œÄ), digits=6))
\`\`\``, 
                packages: '\\usepackage{amsmath,amssymb}' 
            }
        };
        
        function loadTemplate() {
            const key = document.getElementById('templateSelect').value;
            if (key && templates[key]) {
                if (hasUnsavedChanges && !confirm('Discard changes?')) {
                    document.getElementById('templateSelect').value = '';
                    return;
                }
                currentFileId = null;
                fileNameInput.value = key + '.jmd';
                editor.value = templates[key].code;
                document.getElementById('custom-packages').value = templates[key].packages;
                markSaved();
                compile();
            }
            document.getElementById('templateSelect').value = '';
        }
        
        // Resizer
        const resizer = document.getElementById('resizer');
        const editorPane = document.querySelector('.editor-pane');
        const previewPane = document.getElementById('previewPane');
        
        resizer.addEventListener('mousedown', e => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', e => {
            if (!isResizing) return;
            const pct = (e.clientX / document.querySelector('.container').offsetWidth) * 100;
            if (pct > 20 && pct < 80) {
                editorPane.style.flex = `0 0 ${pct}%`;
                previewPane.style.flex = `0 0 ${100 - pct}%`;
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
        
        async function compile() {
            if (compiling) return;
            compiling = true;
            status.textContent = '‚è≥ Compiling...';
            
            try {
                const headers = {
                    'Content-Type': 'text/plain',
                    'X-LaTeX-Packages': btoa(unescape(encodeURIComponent(document.getElementById('custom-packages').value)))
                };
                
                // Add API key if set
                const apiKey = localStorage.getItem('apiKey');
                if (apiKey) {
                    headers['X-API-Key'] = apiKey;
                }
                
                const response = await fetch('/compile', {
                    method: 'POST',
                    headers: headers,
                    body: editor.value
                });
                
                if (response.status === 401) {
                    const key = prompt('API Key required:');
                    if (key) {
                        localStorage.setItem('apiKey', key);
                        compiling = false;
                        return compile();
                    }
                    status.textContent = 'üîí Unauthorized';
                    return;
                }
                
                const logs = response.headers.get('X-Compilation-Logs');
                if (logs) {
                    try { displayLogs(decodeURIComponent(escape(atob(logs)))); }
                    catch { displayLogs(atob(logs)); }
                }
                
                if (response.ok) {
                    preview.src = '/output.pdf?t=' + Date.now();
                    status.textContent = '‚úì Compiled';
                    setTimeout(() => status.textContent = 'Ready', 2000);
                } else {
                    status.textContent = '‚úó Failed';
                    document.getElementById('console').classList.add('visible');
                    document.querySelector('.container').classList.add('panel-open');
                }
            } catch (e) {
                status.textContent = '‚úó Error';
            } finally {
                compiling = false;
            }
        }
        
        editor.addEventListener('input', () => {
            markUnsaved();
            clearTimeout(autoCompileTimeout);
            autoCompileTimeout = setTimeout(compile, 1500);
        });
        
        document.addEventListener('keydown', e => {
            if ((e.metaKey || e.ctrlKey) && e.key === 's') { e.preventDefault(); saveFile(); compile(); }
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); compile(); }
            if ((e.metaKey || e.ctrlKey) && e.key === 'n') { e.preventDefault(); newFile(); }
            if ((e.metaKey || e.ctrlKey) && e.key === 'o') { e.preventDefault(); openFiles(); }
            if ((e.metaKey || e.ctrlKey) && e.key === 'i') { e.preventDefault(); aiAssist(); }
            if (e.key === 'Escape') {
                closeModal();
                const aiModal = document.getElementById('aiModal');
                if (aiModal) aiModal.classList.remove('visible');
            }
        });
        
        window.addEventListener('beforeunload', e => {
            if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; }
        });
        
        function toggleConsole() {
            document.getElementById('settings').classList.remove('visible');
            document.getElementById('console').classList.toggle('visible');
            document.querySelector('.container').classList.toggle('panel-open', 
                document.getElementById('console').classList.contains('visible'));
        }
        
        function toggleSettings() {
            document.getElementById('console').classList.remove('visible');
            document.getElementById('settings').classList.toggle('visible');
            document.querySelector('.container').classList.toggle('panel-open',
                document.getElementById('settings').classList.contains('visible'));
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        
        function setApiKey() {
            const current = localStorage.getItem('apiKey') || '';
            const key = prompt('Enter API Key (leave empty to clear):', current);
            if (key !== null) {
                if (key) {
                    localStorage.setItem('apiKey', key);
                    status.textContent = 'üîë Key saved';
                } else {
                    localStorage.removeItem('apiKey');
                    status.textContent = 'üîë Key cleared';
                }
                setTimeout(() => status.textContent = 'Ready', 2000);
            }
        }
        
        // AI Assist
        async function aiAssist() {
            const aiKey = localStorage.getItem('aiApiKey');
            const aiProvider = localStorage.getItem('aiProvider') || 'groq';
            
            if (!aiKey) {
                showAiSettings();
                return;
            }
            
            const selected = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            const context = selected || editor.value;
            
            const action = prompt('What do you need?\n\n1. fix - Fix errors in code\n2. explain - Explain code\n3. improve - Suggest improvements\n4. generate - Generate code\n\nOr type your own request:', 'fix');
            
            if (!action) return;
            
            status.textContent = '‚ú® AI thinking...';
            
            const prompts = {
                fix: `Fix any errors in this code and explain what was wrong:\n\n${context}`,
                explain: `Explain this code clearly and concisely:\n\n${context}`,
                improve: `Suggest improvements for this code:\n\n${context}`,
                generate: `Generate Julia code for: ${context}`
            };
            
            const userPrompt = prompts[action] || `${action}\n\nCode:\n${context}`;
            
            try {
                let response;
                
                if (aiProvider === 'groq') {
                    response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${aiKey}`
                        },
                        body: JSON.stringify({
                            model: 'llama-3.3-70b-versatile',
                            messages: [
                                { role: 'system', content: 'You are an expert Julia and LaTeX programmer. Be concise. Return code in ```julia or ```latex blocks.' },
                                { role: 'user', content: userPrompt }
                            ],
                            max_tokens: 2048
                        })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    showAiResponse(data.choices[0].message.content);
                    
                } else if (aiProvider === 'claude') {
                    response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': aiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2048,
                            system: 'You are an expert Julia and LaTeX programmer. Be concise. Return code in ```julia or ```latex blocks.',
                            messages: [{ role: 'user', content: userPrompt }]
                        })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    showAiResponse(data.content[0].text);
                }
                
                status.textContent = '‚úì AI response ready';
                setTimeout(() => status.textContent = 'Ready', 2000);
                
            } catch (e) {
                status.textContent = '‚úó AI error';
                alert('AI Error: ' + e.message);
            }
        }
        
        function showAiSettings() {
            const provider = prompt('AI Provider:\n1. groq (FREE - recommended)\n2. claude (paid)\n\nEnter 1 or 2:', '1');
            if (!provider) return;
            
            const providerName = provider === '2' ? 'claude' : 'groq';
            localStorage.setItem('aiProvider', providerName);
            
            const keyUrl = providerName === 'groq' 
                ? 'Get free key at: console.groq.com/keys'
                : 'Get key at: console.anthropic.com';
            
            const key = prompt(`${keyUrl}\n\nEnter your ${providerName.toUpperCase()} API key:`);
            if (key) {
                localStorage.setItem('aiApiKey', key);
                status.textContent = '‚ú® AI configured';
                setTimeout(() => status.textContent = 'Ready', 2000);
            }
        }
        
        function showAiResponse(text) {
            // Create modal for AI response
            let modal = document.getElementById('aiModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'aiModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width:700px;max-height:80vh;display:flex;flex-direction:column;">
                        <h2 style="display:flex;justify-content:space-between;align-items:center;">
                            ‚ú® AI Response
                            <button class="btn secondary" onclick="document.getElementById('aiModal').classList.remove('visible')" style="padding:4px 10px;">‚úï</button>
                        </h2>
                        <pre id="aiContent" style="flex:1;overflow:auto;background:#1e1e1e;color:#d4d4d4;padding:16px;border-radius:4px;font-size:12px;white-space:pre-wrap;margin:16px 0;"></pre>
                        <div class="modal-buttons">
                            <button class="btn secondary" onclick="copyAiCode()">üìã Copy Code</button>
                            <button class="btn" onclick="insertAiCode()">‚¨á Insert to juleaf</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            document.getElementById('aiContent').textContent = text;
            modal.classList.add('visible');
        }
        
        function copyAiCode() {
            const text = document.getElementById('aiContent').textContent;
            const codeMatch = text.match(/```(?:julia|latex)?\n([\s\S]*?)```/);
            const code = codeMatch ? codeMatch[1] : text;
            navigator.clipboard.writeText(code);
            status.textContent = 'üìã Copied!';
            setTimeout(() => status.textContent = 'Ready', 1500);
        }
        
        function insertAiCode() {
            const text = document.getElementById('aiContent').textContent;
            const codeMatch = text.match(/```(?:julia|latex)?\n([\s\S]*?)```/);
            const code = codeMatch ? codeMatch[1] : text;
            
            const pos = editor.selectionStart;
            editor.value = editor.value.slice(0, pos) + code + editor.value.slice(pos);
            editor.selectionStart = editor.selectionEnd = pos + code.length;
            editor.focus();
            
            document.getElementById('aiModal').classList.remove('visible');
            markUnsaved();
        }
        
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
        }
        
        function displayLogs(logs) {
            document.getElementById('console-output').innerHTML = logs
                .replace(/Error:/g, '<span class="error">Error:</span>')
                .replace(/‚úì/g, '<span class="success">‚úì</span>')
                .replace(/‚úó/g, '<span class="error">‚úó</span>');
        }
        
        document.getElementById('custom-packages').value = localStorage.getItem('latex-packages') || '';
        document.getElementById('custom-packages').addEventListener('input', e => {
            localStorage.setItem('latex-packages', e.target.value);
        });
        
        lastSavedContent = editor.value;
        
        // Workspace functions
        function toggleWorkspace() {
            document.getElementById('workspacePanel').classList.toggle('visible');
            if (document.getElementById('workspacePanel').classList.contains('visible')) {
                refreshWorkspace();
            }
        }
        
        async function refreshWorkspace() {
            const container = document.getElementById('workspaceFiles');
            container.innerHTML = '<div class="workspace-empty">Loading...</div>';
            
            try {
                const response = await fetch('/workspace');
                if (response.ok) {
                    const data = await response.json();
                    renderWorkspace(data);
                } else {
                    container.innerHTML = '<div class="workspace-empty">Could not load workspace</div>';
                }
            } catch (e) {
                container.innerHTML = '<div class="workspace-empty">Error loading workspace</div>';
            }
        }
        
        function renderWorkspace(data) {
            const container = document.getElementById('workspaceFiles');
            
            if (!data.files || data.files.length === 0) {
                container.innerHTML = '<div class="workspace-empty">No files yet</div>';
                return;
            }
            
            // Group files by type
            const groups = {
                documents: [],
                outputs: [],
                other: []
            };
            
            data.files.forEach(f => {
                if (f.name.endsWith('.jmd') || f.name.endsWith('.md') || f.name.endsWith('.tex')) {
                    groups.documents.push(f);
                } else if (f.name.endsWith('.pdf') || f.name.endsWith('.png') || f.name.endsWith('.svg')) {
                    groups.outputs.push(f);
                } else {
                    groups.other.push(f);
                }
            });
            
            let html = '';
            
            if (groups.documents.length > 0) {
                html += '<div class="workspace-section">Documents</div>';
                groups.documents.forEach(f => {
                    html += renderFileItem(f, 'üìÑ');
                });
            }
            
            if (groups.outputs.length > 0) {
                html += '<div class="workspace-section">Outputs</div>';
                groups.outputs.forEach(f => {
                    const icon = f.name.endsWith('.pdf') ? 'üìï' : 'üñºÔ∏è';
                    html += renderFileItem(f, icon);
                });
            }
            
            if (groups.other.length > 0) {
                html += '<div class="workspace-section">Other</div>';
                groups.other.forEach(f => {
                    html += renderFileItem(f, 'üìé');
                });
            }
            
            container.innerHTML = html;
        }
        
        function renderFileItem(file, icon) {
            const size = formatFileSize(file.size);
            return `
                <div class="workspace-file" onclick="openWorkspaceFile('${file.name}')" title="${file.name}">
                    <span class="workspace-file-icon">${icon}</span>
                    <span class="workspace-file-name">${file.name}</span>
                    <span class="workspace-file-size">${size}</span>
                </div>
            `;
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        async function openWorkspaceFile(filename) {
            if (filename.endsWith('.pdf')) {
                window.open('/workspace/' + encodeURIComponent(filename), '_blank');
                return;
            }
            
            if (filename.endsWith('.png') || filename.endsWith('.jpg') || filename.endsWith('.svg')) {
                window.open('/workspace/' + encodeURIComponent(filename), '_blank');
                return;
            }
            
            // Text files - load into editor
            if (hasUnsavedChanges && !confirm('Discard unsaved changes?')) return;
            
            try {
                const response = await fetch('/workspace/' + encodeURIComponent(filename));
                if (response.ok) {
                    const text = await response.text();
                    currentFileId = null;
                    fileNameInput.value = filename;
                    editor.value = text;
                    markSaved();
                    compile();
                }
            } catch (e) {
                alert('Could not open file');
            }
        }
        
        window.addEventListener('load', compile);
    </script>
</body>
</html>
